---
layout: default
title: API
---
<h1 id="api">API</h1>

<hr>



<h2 id="what">What ?!!</h2>

<p>If you are reading this, chances are you are a developer that wants to sell an HTML5 application and you probably already asked yourself:</p>

<blockquote>
  <p><em>“how do I handle payments in my application?”</em></p>
</blockquote>

<p>There are two typical answers to this question:</p>

<ul>
<li>You implement payments yourself, however it implies heavy developments in back end,</li>
<li>Or you deal with a store, but it will cost you a substantial part of the actual price.</li>
</ul>

<p><strong>MonetizeJS</strong> is the best of both worlds. Whilst applying a fairly low rate (<strong>5%</strong> + Stripe fees), it provides painless ways to <strong>ask a user for payments</strong> and frequently <strong>check that the user has actually paid</strong> without the need of implementing server logic or user management.</p>



<h2 id="how">How ?</h2>

<p><strong>MonetizeJS</strong> platform is built on top of <a href="https://stripe.com/">Stripe</a>, which lets you charge users and handle recurring payments. Beside calling Stripe to perform payments, MonetizeJS handles the link between your users and your application so you don’t have to manage users yourself in a database.</p>

<p>In MonetizeJS, an application can have two different types of pricing options: <strong>once-off charge</strong> and <strong>subscription</strong>. Each application has a set of pre-defined pricing options, and the link between users and applications is defined as follows:</p>

<ul>
<li>A user may have a <strong>current once-off charge option</strong> for a given application. One can eventually upgrade to another charge option by paying the difference.</li>
<li>Beside, this user may also have a <strong>running subscription option</strong> for that application. One can eventually switch to another subscription option or cancel a running subscription.</li>
</ul>

<blockquote>
  <p><strong>Note:</strong> a user can only have 1 once-off charge and 1 subscription at a time.</p>
</blockquote>

<p>Every time a user comes to your application, you will be able to:</p>

<ol>
<li>Retrieve user’s current pricing option: once-off charge and/or subscription.</li>
<li>Ask for a new charge or a subscription via a redirection to the MonetizeJS platform.</li>
</ol>

<p>A redirection to the MonetizeJS platform is necessary if:</p>

<ul>
<li>the user is not logged in, or</li>
<li>the user doesn’t have the required pricing option.</li>
</ul>

<blockquote>
  <p><strong>Note:</strong> once logged in for the first time, a user will automatically be logged on that computer using a “remember me” cookie. This will prevent you to perform a redirection every time a user comes back to your application.</p>
</blockquote>

<p>Here is the typical workflow:</p>

<ol>
<li><p>Retrieve once-off charge or subscription without redirection (user has to be logged in).</p></li>
<li><p>If retrieve succeeded, validate once-off charge/subscription. If it doesn’t match your requirement, redirect to the platform for payment.</p></li>
<li><p>If retrieval failed, redirect to the platform for login and, eventually, for payment.</p></li>
</ol>

<p>It’s important to note that, if you have to redirect the user for login, you can also tell the platform what you expect as required pricing options. Thus, the platform will be able to ask the user for a payment at the same time.</p>



<h2 id="monetizejs">Monetize.js</h2>

<p><strong>Monetize.js</strong> library is suitable for client side applications, including browser and mobile applications.</p>

<blockquote>
  <p><strong>Careful!</strong> Browsers don’t protect you against user scripts. If payments are critical for your application, you should check them in back end. Check out the <a href="#oauth2">OAuth2 section</a> and the <a href="#rest">REST API section</a> for more information.</p>
</blockquote>



<h3 id="load-the-library">Load the library</h3>

<p><strong>Monetize.js</strong> library can be loaded from our CDN:</p>



<pre class="prettyprint prettyprinted"><code class="language-html"><span class="tag">&lt;script</span><span class="pln"> </span><span class="atn">src</span><span class="pun">=</span><span class="atv">"//d3pv21y5gaggbw.cloudfront.net/api/js/latest/monetize.js"</span><span class="tag">&gt;&lt;/script&gt;</span></code></pre>

<p>It can also be retrieved from <strong>GitHub</strong>, hacked and hosted by you:</p>



<pre class="prettyprint prettyprinted"><code class="language-bash"><span class="pln">git clone https</span><span class="pun">:</span><span class="com">//github.com/monetizejs/monetize.js.git</span></code></pre>

<p>Once loaded, the library needs to be initialized with your application ID:</p>



<pre class="prettyprint prettyprinted"><code class="language-js"><span class="pln">monetize</span><span class="pun">.</span><span class="pln">init</span><span class="pun">({</span><span class="pln">applicationID</span><span class="pun">:</span><span class="pln"> </span><span class="str">'5308c64d92bde8e8d2c772d6'</span><span class="pun">});</span></code></pre>



<h3 id="obtain-users-payments">Obtain user’s payments</h3>

<p><strong>Monetize.js</strong> provides two methods to get user’s payments:</p>

<ul>
<li><strong>immmediate</strong>: if the user is already logged in and have already paid, no redirection is required, the payments are silently retrieved.</li>
<li><strong>interactive</strong>: when the user has to login or make a payment, a redirection to the platform has to be performed.</li>
</ul>



<h4 id="immediate">Immediate</h4>

<p><code>getPaymentsImmediate</code> retrieves payments without redirection, assuming the user is already logged in:</p>



<pre class="prettyprint prettyprinted"><code class="language-js"><span class="pln">monetize</span><span class="pun">.</span><span class="pln">getPaymentsImmediate</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> payments</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">payments</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="com">// User is logged in, you can check payments:</span><span class="pln">
        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">payments</span><span class="pun">.</span><span class="pln">oneTimeCharge</span><span class="pun">);</span><span class="pln">
        console</span><span class="pun">.</span><span class="pln">log</span><span class="pun">(</span><span class="pln">payments</span><span class="pun">.</span><span class="pln">subscription</span><span class="pun">);</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
    </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="com">// User is not logged in...</span><span class="pln">
    </span><span class="pun">}</span><span class="pln">
</span><span class="pun">});</span></code></pre>

<dl>
<dt>Try it:</dt>
<dd>
<p>Get payments <span class="glyphicon glyphicon-chevron-right"></span></p>
</dd>
</dl>


function paymentsImmediate() {
    monetize.init({applicationID: '5308c64d92bde8e8d2c772d6'});
    monetize.getPaymentsImmediate(function(err, payments) {
        if(payments) {
            alert('User is logged in!\n\nTotal amount of charges: ' + payments.oneTimeCharge + '\nRunning subscription: ' + payments.subscription);
        }
        else {
            alert('User is not logged in...');
        }
    });
}


<blockquote>
  <p><strong>Note:</strong> In most cases, when an error occurs, you will have to call <code>getPaymentsInteractive</code>.</p>
</blockquote>



<h4 id="interactive-with-redirection">Interactive with redirection</h4>

<p>When <code>getPaymentsImmediate</code> fails because the user is not logged in or if the user doesn’t have the required pricing option, you will have to call <code>getPaymentsInteractive</code>, passing the possible pricing options as a parameter. The will redirect the user to the platform for login, if not already logged in, and for payment, if the user doesn’t have one of the expected pricing options.</p>

<p>Here is how you perform a full-page redirection:</p>



<pre class="prettyprint prettyprinted"><code class="language-js"><span class="pln">monetize</span><span class="pun">.</span><span class="pln">getPaymentsInteractive</span><span class="pun">();</span></code></pre>

<p>This will bring your user to the <strong>MonetizeJS</strong> platform. After login and payment, the platform will redirect the user back to your page where you will call <code>getPaymentsImmediate</code> again.</p>

<dl>
<dt>Try it:</dt>
<dd>
<p>Redirect! <span class="glyphicon glyphicon-chevron-right"></span></p>
</dd>
</dl>


function tokenInteractiveRedirect() {
    monetize.getTokenInteractive({applicationID: '5308c64d92bde8e8d2c772d6'});
}


<blockquote>
  <p><strong>Tip:</strong> You can specify a custom redirect URL, as long as it’s declared in the application authorized redirect URLs:</p>
</blockquote>



<pre class="prettyprint prettyprinted"><code class="language-js"><span class="pln">monetize</span><span class="pun">.</span><span class="pln">getPaymentsInteractive</span><span class="pun">({</span><span class="pln">
    redirectURL</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://mydomain.com/otherpage.html'</span><span class="pln">
</span><span class="pun">});</span></code></pre>



<h4 id="interactive-with-popup">Interactive with popup</h4>

<p>If you prefer to popup a window in order to keep the current page context, just add a callback, much like <code>getTokenImmediate</code>:</p>



<pre class="prettyprint prettyprinted"><code class="language-js"><span class="pln">monetize</span><span class="pun">.</span><span class="pln">getTokenInteractive</span><span class="pun">({</span><span class="pln">
    applicationID</span><span class="pun">:</span><span class="pln"> </span><span class="str">'5308c64d92bde8e8d2c772d6'</span><span class="pln">
</span><span class="pun">},</span><span class="pln"> </span><span class="kwd">function</span><span class="pun">(</span><span class="pln">err</span><span class="pun">,</span><span class="pln"> token</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
    </span><span class="pun">...</span><span class="pln">
</span><span class="pun">});</span></code></pre>

<dl>
<dt>Try it:</dt>
<dd>
<p>Popup! <span class="glyphicon glyphicon-chevron-right"></span></p>
</dd>
</dl>


function tokenInteractivePopup() {
    monetize.getTokenInteractive({applicationID: '5308c64d92bde8e8d2c772d6'}, function(err, token) {
        if(token) {
            alert('Yes, user is logged in!\n\nToken: ' + token);
        }
        else {
            alert('No, user is not logged in.');
        }
    });
}


<blockquote>
  <p><strong>Careful!</strong> Using popups, make sure <code>getTokenInteractive</code> is triggered by a user click event, otherwise popups will get blocked by the browser.</p>
  
  <ul>
  <li>A token is returned whether or not the user has paid for your application. Next: use the token and the proper method to check payments.</li>
  <li><strong>Monetize.js</strong> retrieves 1h validity short-term tokens. During this time, <code>getTokenImmediate</code> will return the same token. But no worries, it will take care of refreshing it before it gets outdated.</li>
  </ul>
</blockquote>



<h2 id="oauth2">OAuth2</h2>

<p><strong>MonetizeJS</strong> platform is OAuth2 compliant.</p>

<blockquote>
  <p><strong>Note</strong>: You are responsible for keeping your application’s secret and your users’ token in a safe place.</p>
  
  <p><strong>Note</strong>: The platform also supports implicit grant, but you probably should use <a href="#monetizejs">Monetize.js library</a> instead.</p>
</blockquote>



<h2 id="rest">REST</h2>

<p><strong>MonetizeJS</strong> platform has a single end point in its REST API: <code>GET /api/payments</code>.</p>

<p>The purpose of this end point is to retrieve user’s payments. A token has to be passed as a URL parameter:</p>



<pre class="prettyprint prettyprinted"><code class="language-bash"><span class="pln">curl http</span><span class="pun">:</span><span class="com">//localhost:3000/api/payments?access_token=USER_TOKEN_HERE</span></code></pre>

<p>Or in the authorization header:</p>



<pre class="prettyprint prettyprinted"><code class="language-bash"><span class="pln">curl http</span><span class="pun">:</span><span class="com">//localhost:3000/api/payments -H "Authorization: Bearer USER_TOKEN_HERE"</span></code></pre>

<blockquote>
  <p><strong>Note:</strong> You can negotiate a token on the client side using the <a href="#monetizejs">Monetize.js library</a>. All you have to do is call <code>getTokenImmediate</code> or <code>getTokenInteractive</code> the same way you would call <code>getPaymentImmediate</code> or <code>getPaymentInteractive</code>. Unlike the OAuth2 token, the validity of a client side token is 1 hour (automatically refreshed by the Monetize.js library).</p>
</blockquote>

<p>The end point supports CORS, so you can call it from the browser:</p>



<pre class="prettyprint prettyprinted"><code class="language-js"><span class="pln">$</span><span class="pun">.</span><span class="pln">ajax</span><span class="pun">(</span><span class="str">'http://localhost:3000/api/payments?access_token=USER_TOKEN_HERE'</span><span class="pun">)</span><span class="pln">
    </span><span class="pun">.</span><span class="pln">then</span><span class="pun">(</span><span class="kwd">function</span><span class="pun">(</span><span class="pln">payments</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln">
        </span><span class="pun">...</span><span class="pln">
    </span><span class="pun">});</span></code></pre>

<p>JSONP is also supported using the <code>callback</code> parameter.</p>



<h2 id="couchdb">CouchDB</h2>

<p><strong>MonetizeJS</strong> uses <a href="http://couchdb.apache.org/">CouchDB</a> in back-end to store users, applications and transaction logs. You can actually query MonetizeJS databases using the standard CouchDB REST API in order to retrieve:</p>

<ul>
<li>application statistics,</li>
<li>particular transactions,</li>
<li>…</li>
</ul>