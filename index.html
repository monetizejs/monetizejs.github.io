---
layout: default
---

<h1 id="api">API</h1>

<hr>



<h2 id="what">What ?!</h2>

<p>If you are reading this, you are probably a developer that wants to sell a web application or a mobile game and you probably already asked yourself:</p>

<blockquote>
  <p><em>“how do I handle payments in my application?”</em></p>
</blockquote>

<p>These are two typical answers:</p>

<ul>
<li>You implement payments yourself, however it implies heavy developments in back,</li>
<li>Or you deal with a store, but it will cost you a substantial part of the actual price.</li>
</ul>

<p><strong>MonetizeJS</strong> is the best of both worlds. Whilst applying a fairly low rate (<strong>5%</strong> + Stripe fees), it provides painless ways to <strong>ask a user for payments</strong> and frequently <strong>check that the user has actually paid</strong> without the need of implementing server logic or users management.</p>

<h2 id="how">How ?</h2>

<p><strong>MonetizeJS</strong> platform is built on top of <a href="https://stripe.com/docs/api">Stripe</a>, which lets you charge users and handle recurring payments. However, the concept of “application” is implemented in MonetizeJS and the link between users and applications is defined as follows:</p>

<ul>
<li>A user has a <strong>total funds</strong> for a given application. These funds are convertible to a <strong>one-time charge</strong> option for that application, and eventually, <strong>invitations</strong> for other users.</li>
<li>Beside, this user may also have <strong>running subscriptions</strong> for that application. These running subscriptions are usually composed of a personal <strong>subscription</strong> option for that application, and eventually, <strong>invitations</strong> for other users.</li>
</ul>

<p>Every time a user comes to your application, you will be able to:</p>

<ol>
<li>Retrieve user’s current option: one-time charge and/or subscription one has payed for, or has been invited to. You don’t have to redirect a user to the MonetizeJS platform, unless the user is not logged in on the platform or doesn’t have the required payment option.</li>
<li>Ask one for a new charge or a subscription.</li>
</ol>

<blockquote>
  <p><strong>Note:</strong> once logged in for the first time, a user will automatically be logged on that computer using a “remember me” cookie. That way you don’t have to perform a redirection every time a user comes back to  your application.</p>
</blockquote>

<p>Here is the typical workflow:</p>

<ol>
<li><p>Retrieve one-time charge/subscription without redirection (the user has to be logged in).</p></li>
<li><p>If retrieve succeeded, validate one-time charge/subscription. If it doesn’t match your requirement, redirect the user to the platform for payment.</p></li>
<li><p>If retrieve failed, redirect the user to the platform for login and, eventually, for payment.</p></li>
</ol>

<p>It’s important to note that, if you have to redirect the user for login, you can also tell the platform what you expect as possible payment options (one-time charge and/or subscription). This way, the platform will be able to ask the user to perform a payment at the same time.</p>

<h2 id="monetizejs">Monetize.js</h2>

<p><strong>Monetize.js</strong> library is suitable for client side applications, including browser and mobile applications.</p>

<blockquote>
  <p><strong>Careful!</strong> Browsers don’t protect you against user scripts. If payments are critical for your application, you should check them in back end. Check out the <a href="#oauth2">OAuth2 section</a> for more information.</p>
</blockquote>



<h3 id="loading-the-library">Loading the library</h3>

<p><strong>Monetize.js</strong> library can be loaded from our CDN:</p>



<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"//d3pv21y5gaggbw.cloudfront.net/api/js/latest/monetize.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span></code></pre>

<p>It can also be retrieved from <strong>GitHub</strong>, hacked and hosted by you:</p>

<pre class="prettyprint"><code class="language-bash hljs ">git clone https://github.com/monetizejs/monetize.js.git</code></pre>

<p>Once loaded, the library needs to be initialized with your application ID:</p>



<pre class="prettyprint"><code class="language-js hljs ">monetize.init({applicationID: <span class="hljs-string">'5308c64d92bde8e8d2c772d6'</span>});</code></pre>



<h3 id="obtaining-users-payments">Obtaining user’s payments</h3>

<p><strong>Monetize.js</strong> provides two methods to get user’s payments:</p>

<ul>
<li><strong>immmediate</strong>: if the user is already logged in and have already paid, no UI is required, the payments are silently retrieved.</li>
<li><strong>interactive</strong>: when the user has to login or make a payment, a redirection to the platform has to be performed.</li>
</ul>



<h4 id="immediate">Immediate</h4>

<p><code>getPaymentsImmediate</code> retrieves payments without redirection, assuming the user is already logged in:</p>



<pre class="prettyprint"><code class="language-js hljs ">monetize.getPaymentsImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, payments)</span> {</span>
    <span class="hljs-keyword">if</span>(payments) {
        <span class="hljs-comment">// User is logged in, you can check payments:</span>
        console.log(payments.oneTimeCharge);
        console.log(payments.subscription);
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// User is not logged in...</span>
    }
});</code></pre>

<dl>
<dt>Try it:</dt>
<dd>
<p><button class="btn btn-primary arrow-right" onclick="paymentsImmediate()">Get payments <span class="glyphicon glyphicon-chevron-right"></span></button></p>
</dd>
</dl>

<script>
function paymentsImmediate() {
    monetize.init({applicationID: '5308c64d92bde8e8d2c772d6'});
    monetize.getPaymentsImmediate(function(err, payments) {
        if(payments) {
            alert('User is logged in!\n\nTotal amount of charges: ' + payments.totalAmountOfCharges + '\nRunning subscription: ' + payments.runningSubscription);
        }
        else {
            alert('User is not logged in...');
        }
    });
}
</script>

<blockquote>
  <p><strong>Note:</strong> In most cases, when an error occurs, you will have to call <code>getPaymentsInteractive</code>.</p>
</blockquote>

<h4 id="interactive-with-redirection">Interactive with redirection</h4>

<p>If you don’t get a token using <code>getTokenImmediate</code>, try <code>getTokenInteractive</code>. To perform a full-page redirection, just call:</p>



<pre class="prettyprint"><code class="language-js hljs ">monetize.getTokenInteractive({
    applicationID: <span class="hljs-string">'5308c64d92bde8e8d2c772d6'</span>
});</code></pre>

<p>This will bring your user to the <strong>MonetizeJS</strong> platform. After login and payment process, the platform will redirect the user back to your page with the token in the URL fragment.</p>

<dl>
<dt>Try it:</dt>
<dd>
<p><button class="btn btn-primary arrow-right" onclick="tokenInteractiveRedirect()">Redirect! <span class="glyphicon glyphicon-chevron-right"></span></button></p>
</dd>
</dl>

<script>
function tokenInteractiveRedirect() {
    monetize.getTokenInteractive({applicationID: '5308c64d92bde8e8d2c772d6'});
}
</script>

<blockquote>
  <p><strong>Tip:</strong> You can specify a custom redirect URL:</p>
</blockquote>



<pre class="prettyprint"><code class="language-js hljs ">monetize.getTokenInteractive({
    applicationID: <span class="hljs-string">'5308c64d92bde8e8d2c772d6'</span>,
    redirectURL: <span class="hljs-string">'http://abc.xyz/token_handler.html'</span>
});</code></pre>



<h4 id="interactive-with-popup">Interactive with popup</h4>

<p>If you prefer to popup a window in order to keep the current page context, just add a callback, much like <code>getTokenImmediate</code>:</p>



<pre class="prettyprint"><code class="language-js hljs ">monetize.getTokenInteractive({
    applicationID: <span class="hljs-string">'5308c64d92bde8e8d2c772d6'</span>
}, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err, token)</span> {</span>
    ...
});</code></pre>

<dl>
<dt>Try it:</dt>
<dd>
<p><button class="btn btn-primary arrow-right" onclick="tokenInteractivePopup()">Popup! <span class="glyphicon glyphicon-chevron-right"></span></button></p>
</dd>
</dl>

<script>
function tokenInteractivePopup() {
    monetize.getTokenInteractive({applicationID: '5308c64d92bde8e8d2c772d6'}, function(err, token) {
        if(token) {
            alert('Yes, user is logged in!\n\nToken: ' + token);
        }
        else {
            alert('No, user is not logged in.');
        }
    });
}
</script>

<blockquote>
  <p><strong>Careful!</strong> Using popups, make sure <code>getTokenInteractive</code> is triggered by a user click event, otherwise popups will get blocked by the browser.</p>
  
  <ul>
  <li>A token is returned whether or not the user has paid for your application. Next: use the token and the proper method to check payments.</li>
  <li><strong>Monetize.js</strong> retrieves 1h validity short-term tokens. During this time, <code>getTokenImmediate</code> will return the same token. But no worries, it will take care of refreshing it before it gets outdated.</li>
  </ul>
</blockquote>



<h2 id="oauth2">OAuth2</h2>

<p><strong>MonetizeJS</strong> platform is OAuth2 compliant.</p>

<blockquote>
  <p><strong>Note</strong>: The platform also supports implicit grant, but you probably should use <a href="#monetizejs">Monetize.js</a> instead.</p>
</blockquote>



<h2 id="rest">REST</h2>

<p><strong>MonetizeJS</strong> platform has a single end point in its REST API: <code>GET /api/payments</code>.</p>

<p>The purpose of this end point is to retrieve user’s total amount of charges and running subscription for a given application. User and application are deduced from the bearer token that you have to provide.</p>

<blockquote>
  <p>Use a token either retrieved with Transaction.js <code>getToken</code> method or with the Oauth2 workflow.</p>
</blockquote>

<p>Token can be passed as a URL parameter:</p>



<pre class="prettyprint"><code class="language-bash hljs ">curl http://localhost:<span class="hljs-number">3000</span>/api/payments?access_token=eyJ0eXAiOiJKV1...</code></pre>

<p>Or in the authorization header:</p>



<pre class="prettyprint"><code class="language-bash hljs ">curl http://localhost:<span class="hljs-number">3000</span>/api/payments -H <span class="hljs-string">"Authorization: Bearer eyJ0eXAiOiJKV1..."</span></code></pre>

<p>The end point supports CORS, so you can call it from your web page:</p>



<pre class="prettyprint"><code class="language-js hljs ">$.ajax(<span class="hljs-string">'http://localhost:3000/api/payments?access_token=eyJ0eXAiOiJKV1...'</span>)
.then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(payments)</span> {</span>
    ...
});</code></pre>

<p>JSONP is also supported using the <code>callback</code> parameter.</p>